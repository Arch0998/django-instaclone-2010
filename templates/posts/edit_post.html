{% extends "base.html" %}
{% load static %}

{% block title %}Edit Post - Instaclone 2010{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/forms.css' %}?v=2">
{% endblock %}

{% block content %}
  <div class="auth-container">
    <div class="auth-card" style="max-width: 600px;">
      <div class="auth-header">
        <h3 class="gradient-text">
          <i class="fas fa-edit"></i>
          Edit Post
        </h3>
        <p class="form-help-text">
          Update your post caption.</p>
      </div>

      <div class="auth-body">
        <form method="post">
          {% csrf_token %}

          <div class="form-group-custom">
            <div class="current-image-preview">
              <img src="{{ object.image.url }}" alt="Current post image" class="form-preview-image">
            </div>
          </div>

          <div class="form-group-custom">
            <label for="{{ form.caption.id_for_label }}" class="form-label-custom">
              <i class="fas fa-comment"></i>
              Caption
            </label>
            <textarea
                name="{{ form.caption.name }}"
                id="{{ form.caption.id_for_label }}"
                class="form-control-custom"
                rows="4"
                placeholder="Write a caption... #hashtags #photography #moment"
                style="resize: vertical; min-height: 100px;"
                oninput="highlightHashtags(this)"
            >{{ form.caption.value|default:'' }}</textarea>
            {% if form.caption.errors %}
              <ul class="errorlist">
                {% for error in form.caption.errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              </ul>
            {% endif %}
            <small class="form-help-text">
              <i class="fas fa-hashtag"></i>
              Use hashtags to reach more people
            </small>

            <div id="hashtag-preview" class="hashtag-preview-container">
              <p class="hashtag-preview-title">
                Hashtags detected:</p>
              <div id="hashtags-container" class="hashtags-container"></div>
            </div>
          </div>

          {% if form.non_field_errors %}
            <div class="alert-custom alert-danger">
              {% for error in form.non_field_errors %}
                <span>{{ error }}</span>
              {% endfor %}
            </div>
          {% endif %}

          <div class="form-buttons">
            <button type="submit" class="btn-gradient form-button-primary">
              <i class="fas fa-save"></i>
              Update Post
            </button>
            <a href="{% url 'posts:detail' pk=object.pk %}" class="btn-outline-gradient form-button-secondary">
              <i class="fas fa-times"></i>
              Cancel
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
      function highlightHashtags(textarea) {
          const text = textarea.value;
          const hashtags = text.match(/#\w+/g) || [];
          const hashtagPreview = document.getElementById('hashtag-preview');
          const hashtagsContainer = document.getElementById('hashtags-container');

          if (hashtags.length > 0) {
              hashtagPreview.style.display = 'block';
              hashtagsContainer.innerHTML = '';

              const uniqueHashtags = [...new Set(hashtags)];

              uniqueHashtags.forEach(hashtag => {
                  const tag = document.createElement('span');
                  tag.textContent = hashtag;
                  tag.className = 'hashtag-tag';
                  hashtagsContainer.appendChild(tag);
              });
          } else {
              hashtagPreview.style.display = 'none';
          }
      }

      document.addEventListener('DOMContentLoaded', function() {
          const textarea = document.querySelector('textarea');
          if (textarea && textarea.value) {
              highlightHashtags(textarea);
          }
      });
  </script>
{% endblock %}
